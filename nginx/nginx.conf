server {
    # 监听外部的 80 端口 (HTTP)
    listen 80;

    server_name localhost;

    # 设置请求体的最大允许大小，例如 50M，以支持大文件上传
    client_max_body_size 50M;

    # --- 路由规则 (Locations) ---

    # [规则 1] 处理静态文件请求
    # 当请求的 URL 以 /uploads/ 开头时，由此 location 块处理
    location /uploads/ {
        # 'alias' 指令定义了文件的物理存储路径。
        # 这个路径是 Nginx 容器内的路径，它通过 Docker volume 映射到了 'uploads_data' 卷。
        alias /usr/share/nginx/html/uploads/;
        
        try_files $uri $uri/ =404;
        # 禁用访问日志可以为静态文件服务带来轻微的性能提升 (可选)
        access_log off;

        # 设置浏览器缓存策略，让浏览器缓存静态文件 7 天 (可选)
        # expires 7d;
    }

    # [规则 2] 处理所有其他请求 (API 请求等)
    # 这是一个兜底规则，匹配所有未被前面 location 块匹配的请求
    location / {
        # 使用 proxy_pass 将请求转发给 upstream 定义的 'static_server_backend' 服务组
        proxy_pass http://app:3000;

        # --- 代理头部设置 ---
        # 这些设置对于后端应用正确识别客户端信息至
        
        # 将原始请求的 Host 头传递给后端
        proxy_set_header Host $host;
        # 传递客户端的真实 IP 地址
        proxy_set_header X-Real-IP $remote_addr;
        # 传递代理链中所有服务器的 IP 地址
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        # 传递客户端请求使用的协议 (http 或 https)
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}